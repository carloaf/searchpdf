<!DOCTYPE html>
<html>
<head>
    <title>Teste de Gráficos - SearchPDF</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/charts.css">
    
    <style>
        .debug-container {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .api-response {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            margin-top: 10px;
        }
        .chart-container {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: white;
        }
        h1 {
            color: #2e7d32;
        }
        .test-buttons {
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center mb-4">Teste de Gráficos - SearchPDF</h1>
        
        <div class="debug-container">
            <h3>Ferramentas de Diagnóstico</h3>
            <div class="test-buttons">
                <button id="test-chart-js" class="btn btn-primary">Testar Chart.js</button>
                <button id="test-top-searches" class="btn btn-success">Testar API Top Searches</button>
                <button id="test-doc-distribution" class="btn btn-info">Testar API Document Distribution</button>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <h4>Resposta da API Top Searches:</h4>
                    <div id="top-searches-response" class="api-response">
                        Clique no botão "Testar API Top Searches" para ver a resposta
                    </div>
                </div>
                <div class="col-md-6">
                    <h4>Resposta da API Document Distribution:</h4>
                    <div id="doc-distribution-response" class="api-response">
                        Clique no botão "Testar API Document Distribution" para ver a resposta
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Teste do Chart.js -->
        <div class="chart-container">
            <h3>Teste Básico do Chart.js</h3>
            <canvas id="test-chart" height="200"></canvas>
        </div>
        
        <!-- Top Searches Chart -->
        <div class="chart-container">
            <h3>Top Searches Chart</h3>
            <canvas id="top-searches-chart" height="250"></canvas>
        </div>
        
        <!-- Document Distribution Chart -->
        <div class="chart-container">
            <h3>Document Distribution Chart</h3>
            <div class="mb-3">
                <select id="year-selector" class="form-select">
                    <option value="all">Todos os anos</option>
                </select>
            </div>
            <canvas id="document-distribution-chart" height="250"></canvas>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        // Variáveis para armazenar os gráficos
        let testChart = null;
        let topSearchesChart = null;
        let documentDistributionChart = null;
        
        // Função para inicializar o gráfico de teste
        function initTestChart() {
            const ctx = document.getElementById('test-chart');
            
            // Destruir o gráfico anterior se existir
            if (testChart) testChart.destroy();
            
            testChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Red', 'Blue', 'Yellow', 'Green', 'Purple', 'Orange'],
                    datasets: [{
                        label: 'Test Dataset',
                        data: [12, 19, 3, 5, 2, 3],
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.2)',
                            'rgba(54, 162, 235, 0.2)',
                            'rgba(255, 206, 86, 0.2)',
                            'rgba(75, 192, 192, 0.2)',
                            'rgba(153, 102, 255, 0.2)',
                            'rgba(255, 159, 64, 0.2)'
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(153, 102, 255, 1)',
                            'rgba(255, 159, 64, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        // Função para carregar o gráfico de top searches
        function loadTopSearchesChart(data) {
            const canvasElement = document.getElementById('top-searches-chart');
            
            // Destruir o gráfico anterior se existir
            if (topSearchesChart) topSearchesChart.destroy();
            
            // Configura as cores do gráfico
            const backgroundColors = [
                'rgba(46, 125, 50, 0.8)',    // Verde principal
                'rgba(56, 142, 60, 0.8)',    // Verde mais claro
                'rgba(67, 160, 71, 0.8)',    // Verde ainda mais claro
                'rgba(76, 175, 80, 0.8)',    // Verde primário
                'rgba(102, 187, 106, 0.8)',  // Verde claro
                'rgba(129, 199, 132, 0.8)',  // Verde mais claro
                'rgba(165, 214, 167, 0.8)',  // Verde ainda mais claro
                'rgba(200, 230, 201, 0.8)',  // Verde muito claro
                'rgba(232, 245, 233, 0.8)',  // Verde quase branco
                'rgba(220, 237, 200, 0.8)'   // Verde amarelado
            ];
            
            // Usa as cores em ordem inversa para os hovers
            const hoverColors = [...backgroundColors].map(color => color.replace('0.8', '1'));
            
            // Cria o novo gráfico
            topSearchesChart = new Chart(canvasElement, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Quantidade de Buscas',
                        data: data.counts,
                        backgroundColor: backgroundColors,
                        hoverBackgroundColor: hoverColors,
                        borderColor: 'rgba(46, 125, 50, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',  // Barras horizontais
                    scales: {
                        y: {
                            ticks: {
                                autoSkip: false,
                                callback: function(value, index) {
                                    const label = this.getLabelForValue(index);
                                    // Limita o comprimento do texto visível
                                    return label.length > 20 ? label.substr(0, 20) + '...' : label;
                                }
                            }
                        },
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Quantidade de Buscas',
                                font: {
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                precision: 0
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const index = context.dataIndex;
                                    return `Média de resultados: ${data.avgResults[index]}`;
                                }
                            }
                        },
                        legend: {
                            display: false
                        }
                    },
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }
        
        // Função para carregar o gráfico de distribuição de documentos
        function loadDocumentDistributionChart(data) {
            const canvasElement = document.getElementById('document-distribution-chart');
            
            // Preenche o seletor de ano
            const yearSelector = $('#year-selector');
            yearSelector.empty();
            yearSelector.append('<option value="all">Todos os anos</option>');
            
            data.years.forEach(year => {
                yearSelector.append(`<option value="${year}">${year}</option>`);
            });
            
            // Seleciona o ano atual por padrão, se disponível
            const currentYear = new Date().getFullYear().toString();
            if (data.years.includes(currentYear)) {
                yearSelector.val(currentYear);
            }
            
            // Define as cores para cada mês
            const colorPalette = [
                'rgba(46, 125, 50, 0.8)',    // Verde escuro
                'rgba(56, 142, 60, 0.8)',    
                'rgba(67, 160, 71, 0.8)',    
                'rgba(76, 175, 80, 0.8)',    
                'rgba(102, 187, 106, 0.8)',  
                'rgba(129, 199, 132, 0.8)',  
                'rgba(165, 214, 167, 0.8)',  
                'rgba(200, 230, 201, 0.8)',  
                'rgba(232, 245, 233, 0.8)',  
                'rgba(220, 237, 200, 0.8)',
                'rgba(183, 223, 185, 0.8)',
                'rgba(129, 199, 132, 0.8)'
            ];
            
            // Função para atualizar o gráfico com base no ano selecionado
            function updateChart(selectedYear) {
                // Usa o método do Chart.js para destruir um gráfico existente
                if (documentDistributionChart) {
                    documentDistributionChart.destroy();
                }
                
                // Prepara os dados com base no ano selecionado
                let datasets = [];
                
                if (selectedYear === 'all') {
                    // Para todos os anos, cada ano será uma série de dados
                    data.years.forEach((year, index) => {
                        const yearData = [];
                        
                        // Preenche os dados para cada mês
                        data.monthOrder.forEach(month => {
                            yearData.push(data.data[year] && data.data[year][month] ? data.data[year][month] : 0);
                        });
                        
                        datasets.push({
                            label: `${year}`,
                            data: yearData,
                            backgroundColor: `rgba(${index * 30 + 46}, ${index * 20 + 125}, ${index * 10 + 50}, 0.7)`,
                            borderColor: `rgba(${index * 30 + 46}, ${index * 20 + 125}, ${index * 10 + 50}, 1)`,
                            borderWidth: 1
                        });
                    });
                } else {
                    // Para um ano específico, mostra apenas os dados desse ano
                    const yearData = [];
                    
                    // Preenche os dados para cada mês
                    data.monthOrder.forEach((month, index) => {
                        yearData.push(data.data[selectedYear] && data.data[selectedYear][month] ? 
                            data.data[selectedYear][month] : 0);
                    });
                    
                    datasets.push({
                        label: `Documentos em ${selectedYear}`,
                        data: yearData,
                        backgroundColor: colorPalette,
                        borderColor: colorPalette.map(color => color.replace('0.8', '1')),
                        borderWidth: 1
                    });
                }
                
                // Cria o novo gráfico
                documentDistributionChart = new Chart(canvasElement, {
                    type: 'bar',
                    data: {
                        labels: data.monthOrder,
                        datasets: datasets
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    precision: 0
                                },
                                title: {
                                    display: true,
                                    text: 'Quantidade de Documentos',
                                    font: {
                                        weight: 'bold'
                                    }
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Mês',
                                    font: {
                                        weight: 'bold'
                                    }
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    title: function(tooltipItems) {
                                        return data.monthOrder[tooltipItems[0].dataIndex];
                                    }
                                }
                            }
                        },
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }
            
            // Inicializa o gráfico com o valor selecionado
            updateChart(yearSelector.val());
            
            // Adiciona evento de mudança ao seletor
            yearSelector.on('change', function() {
                updateChart($(this).val());
            });
        }
        
        $(document).ready(function() {
            console.log('Página de teste carregada');
            
            // Inicializa o gráfico de teste
            initTestChart();
            
            // Adiciona eventos aos botões de teste
            $('#test-chart-js').click(function() {
                initTestChart();
                alert('Gráfico de teste inicializado!');
            });
            
            $('#test-top-searches').click(function() {
                $.ajax({
                    url: '/stats/top-searches',
                    method: 'GET',
                    dataType: 'json',
                    success: function(data) {
                        $('#top-searches-response').html(JSON.stringify(data, null, 2));
                        loadTopSearchesChart(data);
                    },
                    error: function(xhr, status, error) {
                        $('#top-searches-response').html('Erro: ' + error + '<br>Status: ' + status + '<br>Resposta: ' + xhr.responseText);
                    }
                });
            });
            
            $('#test-doc-distribution').click(function() {
                $.ajax({
                    url: '/stats/document-distribution',
                    method: 'GET',
                    dataType: 'json',
                    success: function(data) {
                        $('#doc-distribution-response').html(JSON.stringify(data, null, 2));
                        loadDocumentDistributionChart(data);
                    },
                    error: function(xhr, status, error) {
                        $('#doc-distribution-response').html('Erro: ' + error + '<br>Status: ' + status + '<br>Resposta: ' + xhr.responseText);
                    }
                });
            });
        });
    </script>
</body>
</html>
