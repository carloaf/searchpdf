{% extends "auth_base.twig" %}

{% block title %}Upload de PDFs - SearchPDF{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-3">
        <div class="col">
            <h2><i class="fas fa-cloud-upload-alt"></i> Upload de Arquivos PDF</h2>
            <p class="text-muted mb-2">
                Bem-vindo, <strong>{{ username }}</strong> 
                ({{ role }}) | 
                <a href="/" class="text-primary"><i class="fas fa-arrow-left"></i> Voltar para Busca</a> | 
                <a href="/logout" class="text-danger"><i class="fas fa-sign-out-alt"></i> Sair</a>
            </p>
            <div class="d-flex align-items-center gap-2">
                <button type="button" class="btn btn-sm btn-outline-primary" id="btn-reindex-upload" title="Executar indexação de novos arquivos">
                    <i class="fas fa-sync-alt me-1"></i> Sincronizar / Indexar PDFs
                </button>
                <span id="reindex-status" class="small text-muted"></span>
            </div>
        </div>
    </div>
    
    <!-- Formulário de Upload -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-file-upload"></i> Enviar Novo Arquivo</h5>
                </div>
                <div class="card-body">
                    <form id="uploadForm" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="pdf_file" class="form-label">
                                <i class="fas fa-file-pdf"></i> Arquivo PDF *
                            </label>
                            <input 
                                type="file" 
                                class="form-control" 
                                id="pdf_file" 
                                name="pdf_file" 
                                accept="application/pdf"
                                required
                            >
                            <div class="form-text">
                                Tamanho máximo: {{ max_file_size_mb }} MB
                            </div>
                        </div>
                        
                        <!-- Campo oculto para categoria fixa BI -->
                        <input type="hidden" id="category" name="category" value="BI">
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="year" class="form-label">
                                    <i class="fas fa-calendar"></i> Ano *
                                </label>
                                <input 
                                    type="number" 
                                    class="form-control" 
                                    id="year" 
                                    name="year" 
                                    min="2000" 
                                    max="2100" 
                                    value="{{ 'now'|date('Y') }}"
                                    required
                                >
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="month" class="form-label">
                                    <i class="fas fa-calendar-alt"></i> Mês *
                                </label>
                                <select class="form-select" id="month" name="month" required>
                                    <option value="Janeiro">Janeiro</option>
                                    <option value="Fevereiro">Fevereiro</option>
                                    <option value="Março">Março</option>
                                    <option value="Abril">Abril</option>
                                    <option value="Maio">Maio</option>
                                    <option value="Junho">Junho</option>
                                    <option value="Julho">Julho</option>
                                    <option value="Agosto">Agosto</option>
                                    <option value="Setembro">Setembro</option>
                                    <option value="Outubro">Outubro</option>
                                    <option value="Novembro">Novembro</option>
                                    <option value="Dezembro">Dezembro</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success" id="btnUpload">
                                <i class="fas fa-upload"></i> Enviar Arquivo
                            </button>
                        </div>
                        
                        <!-- Progress Bar -->
                        <div class="progress mt-3 d-none" id="uploadProgress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" 
                                 style="width: 0%" 
                                 id="progressBar">0%</div>
                        </div>
                        
                        <!-- Mensagens -->
                        <div id="uploadMessage" class="mt-3"></div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Informações -->
        <div class="col-md-4">
            <div class="card shadow">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="fas fa-info-circle"></i> Instruções</h6>
                </div>
                <div class="card-body">
                    <ul class="small">
                        <li>Apenas arquivos <strong>PDF</strong> são aceitos</li>
                        <li>Tamanho máximo: <strong>{{ max_file_size_mb }} MB</strong></li>
                        <li>Categoria: <strong>Boletim Interno (BI)</strong></li>
                        <li>Selecione o ano e mês corretamente</li>
                        <li>O arquivo será indexado automaticamente</li>
                        <li>Arquivos duplicados não serão aceitos</li>
                    </ul>
                </div>
            </div>
            
            <div class="card shadow mt-3">
                <div class="card-header bg-secondary text-white">
                    <h6 class="mb-0"><i class="fas fa-folder-open"></i> Estrutura de Pastas</h6>
                </div>
                <div class="card-body small">
                    <pre class="mb-0">uploads/
└── BI 2025/
    ├── Janeiro/
    ├── Fevereiro/
    ├── Março/
    └── ...</pre>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Histórico de Uploads -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="fas fa-history"></i> Histórico de Uploads</h5>
                </div>
                <div class="card-body">
                    {% if history is empty %}
                        <p class="text-muted text-center mb-0">Nenhum upload realizado ainda.</p>
                    {% else %}
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>Data/Hora</th>
                                        <th>Arquivo</th>
                                        <th>Ano/Mês</th>
                                        <th>Tamanho</th>
                                        <th>Usuário</th>
                                        <th>Status</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in history %}
                                    <tr data-upload-id="{{ item.id }}">
                                        <td class="small">{{ item.upload_date|date('d/m/Y H:i') }}</td>
                                        <td class="small">{{ item.filename }}</td>
                                        <td class="small">{{ item.year }}/{{ item.month }}</td>
                                        <td class="small">{{ (item.file_size / 1024 / 1024)|number_format(2) }} MB</td>
                                        <td class="small">
                                            <span class="badge bg-secondary">{{ item.username }}</span>
                                        </td>
                                        <td>
                                            {% if item.status == 'success' %}
                                                <span class="badge bg-success">Sucesso</span>
                                            {% elseif item.status == 'indexed' %}
                                                <span class="badge bg-info">Indexado</span>
                                            {% else %}
                                                <span class="badge bg-danger">Falha</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-danger btn-delete-upload" 
                                                    data-id="{{ item.id }}" 
                                                    data-filename="{{ item.filename }}" 
                                                    data-filepath="{{ item.file_path }}"
                                                    title="Deletar arquivo">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('uploadForm');
    const btnUpload = document.getElementById('btnUpload');
    const uploadProgress = document.getElementById('uploadProgress');
    const progressBar = document.getElementById('progressBar');
    const uploadMessage = document.getElementById('uploadMessage');
    
    // Define o mês atual
    const currentMonth = new Date().toLocaleString('pt-BR', { month: 'long' });
    const monthSelect = document.getElementById('month');
    const monthMap = {
        'janeiro': 'Janeiro', 'fevereiro': 'Fevereiro', 'março': 'Março',
        'abril': 'Abril', 'maio': 'Maio', 'junho': 'Junho',
        'julho': 'Julho', 'agosto': 'Agosto', 'setembro': 'Setembro',
        'outubro': 'Outubro', 'novembro': 'Novembro', 'dezembro': 'Dezembro'
    };
    monthSelect.value = monthMap[currentMonth.toLowerCase()];
    
    // Handler para o botão de reindex
    const btnReindex = document.getElementById('btn-reindex-upload');
    const reindexStatus = document.getElementById('reindex-status');
    
    btnReindex.addEventListener('click', function() {
        const icon = this.querySelector('i');
        btnReindex.disabled = true;
        icon.classList.add('fa-spin');
        reindexStatus.textContent = 'Indexando...';
        reindexStatus.className = 'small text-info';
        
        fetch('../run-indexer.php', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                icon.classList.remove('fa-spin');
                reindexStatus.textContent = data.message;
                reindexStatus.className = 'small text-success';
            } else {
                icon.classList.remove('fa-spin');
                reindexStatus.textContent = 'Erro: ' + data.message;
                reindexStatus.className = 'small text-danger';
            }
        })
        .catch(error => {
            icon.classList.remove('fa-spin');
            reindexStatus.textContent = 'Erro ao executar indexação';
            reindexStatus.className = 'small text-danger';
        })
        .finally(() => {
            btnReindex.disabled = false;
            setTimeout(() => {
                reindexStatus.textContent = '';
            }, 5000);
        });
    });
    
    // Handler para botões de deletar
    document.querySelectorAll('.btn-delete-upload').forEach(btn => {
        btn.addEventListener('click', function() {
            const uploadId = this.dataset.id;
            const filename = this.dataset.filename;
            const filepath = this.dataset.filepath;
            
            if (!confirm(`Tem certeza que deseja deletar o arquivo:\n\n${filename}?\n\nEsta ação não pode ser desfeita!`)) {
                return;
            }
            
            // Desabilita o botão
            this.disabled = true;
            const originalHtml = this.innerHTML;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            // Envia requisição DELETE
            fetch(`/upload/${uploadId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ file_path: filepath })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Remove a linha da tabela
                    const row = document.querySelector(`tr[data-upload-id="${uploadId}"]`);
                    row.style.backgroundColor = '#d4edda';
                    setTimeout(() => {
                        row.remove();
                        // Se não há mais linhas, recarrega a página
                        if (document.querySelectorAll('tbody tr').length === 0) {
                            location.reload();
                        }
                    }, 500);
                } else {
                    alert('Erro ao deletar arquivo: ' + (data.error || data.message));
                    this.disabled = false;
                    this.innerHTML = originalHtml;
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao deletar arquivo. Verifique o console.');
                this.disabled = false;
                this.innerHTML = originalHtml;
            });
        });
    });
    
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(form);
        
        // Desabilita botão
        btnUpload.disabled = true;
        btnUpload.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
        
        // Mostra barra de progresso
        uploadProgress.classList.remove('d-none');
        uploadMessage.innerHTML = '';
        
        // Simula progresso (AJAX real não tem onprogress direto no fetch)
        let progress = 0;
        const interval = setInterval(() => {
            progress += 10;
            if (progress >= 90) clearInterval(interval);
            progressBar.style.width = progress + '%';
            progressBar.textContent = progress + '%';
        }, 200);
        
        // Envia via fetch
        fetch('/upload', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            clearInterval(interval);
            progressBar.style.width = '100%';
            progressBar.textContent = '100%';
            
            if (data.success) {
                uploadMessage.innerHTML = '<div class="alert alert-success"><i class="fas fa-check-circle"></i> ' + data.message + '</div>';
                form.reset();
                setTimeout(() => location.reload(), 2000);
            } else {
                uploadMessage.innerHTML = '<div class="alert alert-danger"><i class="fas fa-times-circle"></i> ' + data.error + '</div>';
            }
        })
        .catch(error => {
            clearInterval(interval);
            uploadMessage.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> Erro ao enviar arquivo.</div>';
            console.error('Erro:', error);
        })
        .finally(() => {
            btnUpload.disabled = false;
            btnUpload.innerHTML = '<i class="fas fa-upload"></i> Enviar Arquivo';
            setTimeout(() => {
                uploadProgress.classList.add('d-none');
                progressBar.style.width = '0%';
            }, 2000);
        });
    });
});
</script>
{% endblock %}
